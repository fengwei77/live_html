# æª”æ¡ˆåç¨±ï¼š.github/workflows/code-review.yml

name: AI Code Review with GLM

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize]

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      # éœ€è¦é€™å€‹æ¬Šé™ä¾†è®€å–è©•è«–ï¼Œä»¥ä¾¿æ‰¾åˆ°è¦æ›´æ–°çš„é‚£ä¸€æ¢
      issues: read 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Code Diff
        id: get-diff
        run: |
          DIFF=$(git diff --unified=0 origin/${{ github.event.pull_request.base.ref }}...${{ github.event.pull_request.head.ref }})
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Call GLM for Code Review
        id: call-glm
        run: |
          # (æ­¤è™•çš„ PROMPT å’Œ curl æŒ‡ä»¤èˆ‡ä¹‹å‰å®Œå…¨ç›¸åŒ)
          PROMPT=$(cat <<EOF
          ä½ æ˜¯ä¸€ä½è³‡æ·±è»Ÿé«”å·¥ç¨‹å¸«å’Œç¨‹å¼ç¢¼å¯©æŸ¥å°ˆå®¶ã€‚è«‹ä»”ç´°å¯©æŸ¥ä»¥ä¸‹ç¨‹å¼ç¢¼è®Šæ›´...
          ... (å…§å®¹ä¸è®Š) ...
          --- ç¨‹å¼ç¢¼å·®ç•°é–‹å§‹ ---
          ${{ steps.get-diff.outputs.diff }}
          --- ç¨‹å¼ç¢¼å·®ç•°çµæŸ ---
          EOF
          )
          RESPONSE=$(curl -s -X POST "https://open.bigmodel.cn/api/paas/v4/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.ZAI_API_KEY }}" \
            -d "{\"model\": \"glm-4\", \"messages\": [{\"role\": \"user\", \"content\": \"$PROMPT\"}], \"temperature\": 0.3, \"max_tokens\": 2000}")
          REVIEW_CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ­¥é©Ÿ 4 (ä¿®æ”¹ç‰ˆ)ï¼šå°‹æ‰¾ä¸¦æ›´æ–°èˆŠè©•è«–ï¼Œå¦‚æœæ²’æœ‰å‰‡å‰µå»ºæ–°çš„
      - name: Post or Update Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const reviewOutput = `${{ steps.call-glm.outputs.review }}`;
            const botCommentIdentifier = '### ğŸ¤– GLM ç¨‹å¼ç¢¼å¯©æŸ¥å ±å‘Š'; // ç”¨æ–¼è­˜åˆ¥æ©Ÿå™¨äººè©•è«–çš„æ¨™è¨˜
            
            if (!reviewOutput || reviewOutput.trim() === '') {
              console.log("GLM æ²’æœ‰è¿”å›å¯©æŸ¥å…§å®¹ï¼Œè·³éç™¼å¸ƒè©•è«–ã€‚");
              return;
            }

            // ç²å– PR çš„æ‰€æœ‰è©•è«–
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            // å°‹æ‰¾æ©Ÿå™¨äººç™¼å¸ƒçš„ä¸Šä¸€æ¢è©•è«–
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && comment.body.startsWith(botCommentIdentifier)
            );

            const newBody = `${botCommentIdentifier}\n\n${reviewOutput}`;

            if (botComment) {
              // å¦‚æœæ‰¾åˆ°äº†èˆŠè©•è«–ï¼Œå°±æ›´æ–°å®ƒ
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: newBody
              });
              console.log(`å·²æ›´æ–°è©•è«– #${botComment.id}`);
            } else {
              // å¦‚æœæ²’æœ‰æ‰¾åˆ°ï¼Œå°±å‰µå»ºä¸€æ¢æ–°çš„
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: newBody
              });
              console.log("å·²å‰µå»ºæ–°è©•è«–");
            }