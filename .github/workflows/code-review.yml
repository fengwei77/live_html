# æª”æ¡ˆåç¨±ï¼š.github/workflows/code-review.yml

name: AI Code Review with GLM

# è§¸ç™¼æ¢ä»¶ï¼šç•¶æœ‰æ–°çš„æˆ–è¢«æ›´æ–°çš„ Pull Request é‡å° main åˆ†æ”¯æ™‚
on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize] # 'synchronize' ä»£è¡¨æœ‰æ–°çš„ commit è¢« push åˆ° PR

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      # éœ€è¦é€™å€‹æ¬Šé™æ‰èƒ½åœ¨ PR ä¸Šç™¼å¸ƒè©•è«–
      pull-requests: write

    steps:
      # æ­¥é©Ÿ 1ï¼šæª¢å‡ºç¨‹å¼ç¢¼
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # éœ€è¦æª¢å‡ºæ‰€æœ‰æ­·å²è¨˜éŒ„ï¼Œæ‰èƒ½æ­£ç¢ºè¨ˆç®— diff
          fetch-depth: 0

      # æ­¥é©Ÿ 2ï¼šç²å–ç¨‹å¼ç¢¼å·®ç•°
      - name: Get Code Diff
        id: get-diff
        run: |
          # ä½¿ç”¨ git diff ç²å–ç›®æ¨™åˆ†æ”¯å’Œç•¶å‰åˆ†æ”¯çš„å·®ç•°
          # --unified=0 è¡¨ç¤ºä¸é¡¯ç¤ºä¸Šä¸‹æ–‡ï¼Œåªé¡¯ç¤ºè®Šæ›´çš„è¡Œ
          DIFF=$(git diff --unified=0 origin/${{ github.event.pull_request.base.ref }}...${{ github.event.pull_request.head.ref }})
          # å°‡ diff å…§å®¹å­˜ç‚ºç’°å¢ƒè®Šæ•¸ï¼Œä¸¦è™•ç†ç‰¹æ®Šå­—å…ƒ
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ­¥é©Ÿ 3ï¼šå‘¼å« GLM API é€²è¡Œç¨‹å¼ç¢¼å¯©æŸ¥
      - name: Call GLM for Code Review
        id: call-glm
        run: |
          # æº–å‚™ä¸€å€‹å°ˆæ¥­çš„æç¤ºè©
          PROMPT=$(cat <<EOF
          ä½ æ˜¯ä¸€ä½è³‡æ·±è»Ÿé«”å·¥ç¨‹å¸«å’Œç¨‹å¼ç¢¼å¯©æŸ¥å°ˆå®¶ã€‚è«‹ä»”ç´°å¯©æŸ¥ä»¥ä¸‹ç¨‹å¼ç¢¼è®Šæ›´ï¼ˆGit Diff æ ¼å¼ï¼‰ï¼Œä¸¦æä¾›å›é¥‹ã€‚

          è«‹å¾ä»¥ä¸‹å¹¾å€‹è§’åº¦é€²è¡Œåˆ†æï¼š
          1.  **æ½›åœ¨éŒ¯èª¤**ï¼šæ˜¯å¦æœ‰é‚è¼¯éŒ¯èª¤ã€ç©ºæŒ‡é‡ã€é‚Šç•Œæ¢ä»¶å•é¡Œç­‰ï¼Ÿ
          2.  **å®‰å…¨æ€§å•é¡Œ**ï¼šæ˜¯å¦å­˜åœ¨æ½›åœ¨çš„å®‰å…¨æ¼æ´ï¼Œå¦‚ SQL æ³¨å…¥ã€XSSã€æ¬Šé™ç¹éç­‰ï¼Ÿ
          3.  **æ•ˆèƒ½å•é¡Œ**ï¼šæ˜¯å¦æœ‰ä½æ•ˆçš„æ¼”ç®—æ³•ã€ä¸å¿…è¦çš„è³‡æºæ¶ˆè€—ã€N+1 æŸ¥è©¢ç­‰ï¼Ÿ
          4.  **ç¨‹å¼ç¢¼å“è³ªèˆ‡å¯è®€æ€§**ï¼šç¨‹å¼ç¢¼æ˜¯å¦æ¸…æ™°ã€æ˜“æ–¼ç¶­è­·ï¼Ÿæ˜¯å¦éµå¾ªäº†è‰¯å¥½çš„ç·¨ç¢¼è¦ç¯„ï¼Ÿ
          5.  **æ”¹é€²å»ºè­°**ï¼šæä¾›å…·é«”çš„ã€å¯åŸ·è¡Œçš„æ”¹é€²å»ºè­°ã€‚

          è«‹ä½¿ç”¨ Markdown æ ¼å¼å›è¦†ï¼Œçµæ§‹æ¸…æ™°ï¼Œå°å•é¡Œé»é€²è¡Œå¼•ç”¨ã€‚

          --- ç¨‹å¼ç¢¼å·®ç•°é–‹å§‹ ---
          ${{ steps.get-diff.outputs.diff }}
          --- ç¨‹å¼ç¢¼å·®ç•°çµæŸ ---
          EOF
          )

          # ä½¿ç”¨ curl å‘¼å« GLM API
          RESPONSE=$(curl -s -X POST "https://open.bigmodel.cn/api/paas/v4/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.ZAI_API_KEY }}" \
            -d "{
              \"model\": \"glm-4\",
              \"messages\": [
                {\"role\": \"user\", \"content\": \"$PROMPT\"}
              ],
              \"temperature\": 0.3,
              \"max_tokens\": 2000
            }")

          # ä½¿ç”¨ jq å¾ JSON å›æ‡‰ä¸­æå–å¯©æŸ¥å…§å®¹
          # å¦‚æœæ²’æœ‰å®‰è£ jqï¼Œå¯ä»¥å…ˆåŸ·è¡Œ sudo apt-get install jq
          REVIEW_CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          
          # å°‡å¯©æŸ¥å…§å®¹å­˜ç‚ºç’°å¢ƒè®Šæ•¸ï¼Œä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ­¥é©Ÿ 4ï¼šå°‡å¯©æŸ¥çµæœä½œç‚ºè©•è«–ç™¼å¸ƒåˆ° Pull Request
      - name: Post Review Comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            const reviewOutput = `${{ steps.call-glm.outputs.review }}`;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å¯¦è³ªçš„å¯©æŸ¥å…§å®¹
            if (reviewOutput && reviewOutput.trim() !== '') {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `### ğŸ¤– GLM ç¨‹å¼ç¢¼å¯©æŸ¥å ±å‘Š\n\n${reviewOutput}`
              });
            } else {
              console.log("GLM æ²’æœ‰è¿”å›å¯©æŸ¥å…§å®¹ï¼Œæˆ– diff ç‚ºç©ºï¼Œè·³éç™¼å¸ƒè©•è«–ã€‚");
            }